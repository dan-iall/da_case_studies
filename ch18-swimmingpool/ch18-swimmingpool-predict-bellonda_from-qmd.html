<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Prepared for Gaborâ€™s Data Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/clipboard/clipboard.min.js"></script>
<script src="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/quarto-html/popper.min.js"></script>
<script src="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/quarto-html/anchor.min.js"></script>
<link href="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ch18-swimmingpool-predict-bellonda_from-qmd_files/libs/bootstrap/bootstrap-1e118674f8eeaf0dc11d6faf9a2d8791.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Prepared for Gaborâ€™s Data Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="data-analysis-for-business-economics-and-policy" class="level3">
<h3 class="anchored" data-anchor-id="data-analysis-for-business-economics-and-policy">Data Analysis for Business, Economics, and Policy</h3>
<p>by Gabor Bekes and Gabor Kezdi</p>
<p>Cambridge University Press 2021</p>
<p><a href="https://gabors-data-analysis.com/"><strong>gabors-data-analysis.com</strong></a></p>
<p>License: Free to share, modify and use for educational purposes. Not to be used for commercial purposes.</p>
</section>
<section id="chapter-18" class="level3">
<h3 class="anchored" data-anchor-id="chapter-18">Chapter 18</h3>
<p><strong>CH18 Forecasting daily ticket sales for a swimming pool</strong></p>
<p>using swim data</p>
<p>version 0.9.0 2025-08-14</p>
</section>
<section id="bellondas-decoder-the-setup-phase" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-setup-phase">ğŸ Bellondaâ€™s Decoder: The Setup Phase</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Before we can predict ticket sales, we need to equip our character (the Python script) with skills. Weâ€™re loading libraries: <code>pandas</code> for tables, <code>numpy</code> for math, and <code>seaborn</code> for pretty pictures.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>import ... as ...</code> | <strong>The Alias</strong> | â€œLoad this library but call it by a nickname so I donâ€™t have to type <code>pandas</code> 500 times.â€ | | <code>warnings.filterwarnings</code> | <strong>The Silencer</strong> | â€œTell Python to shut up about minor complaints so our output remains clean.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œWe are setting up the software environment with the necessary tools for analysis.â€</p>
<p><strong>4. ğŸŒ The Banana Peel (Watch Out!)</strong> &gt; [!WARNING] &gt; <strong>Donâ€™t slip here:</strong> If you donâ€™t install these libraries (<code>pip install pandas pyfixest</code>), this cell will crash immediately.</p>
<div id="439cf58b" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Bringing tools from the void</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os  <span class="co"># Operating System: The map to our file locations</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys  <span class="co"># System: To manipulate the path of our journey</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings  <span class="co"># Warnings: To silence the minor spirits</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime  <span class="co"># Time: To understand the flow of ages</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np  <span class="co"># NumPy: The fundamental math of the elves</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd  <span class="co"># Pandas: The table-manipulation magic</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns  <span class="co"># Seaborn: To weave beautiful visual illusions</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt  <span class="co"># Matplotlib: The canvas for our art</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas_market_calendars <span class="im">as</span> mcal  <span class="co"># Calendars: Knowledge of the holidays</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyfixest <span class="im">as</span> pf  <span class="co"># PyFixest: High-performance econometric spells</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> root_mean_squared_error  <span class="co"># RMSE: The judge of our accuracy</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Silencing warnings to keep the mind clear</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-the-gps-setup" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-gps-setup">ğŸ Bellondaâ€™s Decoder: The GPS Setup</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We need to tell Python exactly where our data lives (<code>data_in</code>) and where to dump our results (<code>output</code>). Hardcoding paths is for amateurs; we build them dynamically so they work on any machine.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>os.getcwd()</code> | <strong>The Compass</strong> | â€œWhere am I right now?â€ | | <code>sys.path.append()</code> | <strong>The Bridge</strong> | â€œAdd this new folder to the list of places Python looks for code.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œConfiguring file directories so the automation runs smoothly on any computer.â€</p>
<p><strong>4. ğŸŒ The Banana Peel (Watch Out!)</strong> &gt; [!WARNING] &gt; <strong>Donâ€™t slip here:</strong> <code>os.getcwd()</code> depends on where you <em>run</em> the script from. If you run this from a different folder, all your paths might break!</p>
<div id="176b8c1d" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the Path: Where does our journey begin?</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Current script folder - finding our feet</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>current_path <span class="op">=</span> os.getcwd()</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>dirname <span class="op">=</span> current_path.split(<span class="st">"da_case_studies"</span>)[<span class="dv">0</span>]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining the locations of our artifacts (Directories)</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>data_in <span class="op">=</span> dirname <span class="op">+</span> <span class="st">"da_data_repo/swim-transactions/clean/"</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>data_out <span class="op">=</span> dirname <span class="op">+</span> <span class="st">"da_case_studies/ch18-swim-transactions/"</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> dirname <span class="op">+</span> <span class="st">"da_case_studies/ch18-swim-transactions/output/"</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>func <span class="op">=</span> dirname <span class="op">+</span> <span class="st">"da_case_studies/ch00-tech-prep/"</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding the function directory to our spellbook path</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>sys.path.append(func)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-the-interior-decorator" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-interior-decorator">ğŸ Bellondaâ€™s Decoder: The Interior Decorator</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Default matplotlib charts are ugly. We are importing a custom theme helper (<code>py_helper_functions</code>) to make our charts look professional (and consistent with the book).</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>sns.set_theme()</code> | <strong>The Vibe</strong> | â€œChange the global defaults (colors, fonts) for all future plots.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œApplying our corporate branding/style guide to the charts.â€</p>
<div id="d1284dd7" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> py_helper_functions <span class="im">as</span> da</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set custom color scheme for plots - The Robes of the Mage</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>sns.set_theme(rc<span class="op">=</span>da.da_theme, palette<span class="op">=</span>da.color)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="read-data" class="level3">
<h3 class="anchored" data-anchor-id="read-data">Read data</h3>
</section>
<section id="bellondas-decoder-the-ingestion-with-a-twist" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-ingestion-with-a-twist">ğŸ Bellondaâ€™s Decoder: The Ingestion (With a Twist)</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We are loading the raw data. BUT, we are doing something specific: <code>parse_dates</code>. If we donâ€™t do this, dates are just text strings, and we canâ€™t do math with them.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>pd.read_csv()</code> | <strong>The Loader</strong> | â€œOpen this text file and turn it into a DataFrame.â€ | | <code>parse_dates=['date']</code> | <strong>The Converter</strong> | â€œFind the column named â€˜dateâ€™ and instantly turn it into actual Time objects.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œImporting the sales records.â€</p>
<p><strong>4. ğŸŒ The Banana Peel (Watch Out!)</strong> &gt; [!WARNING] &gt; <strong>Donâ€™t slip here:</strong> If you forget <code>parse_dates</code>, youâ€™ll have to manually convert it later with <code>pd.to_datetime()</code>. Do it now and save time.</p>
<div id="a5916551" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading the scroll (CSV) and interpreting the "date" runes immediately</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>daily_agg <span class="op">=</span> pd.read_csv(os.path.join(data_in, <span class="st">"swim_work.csv"</span>), parse_dates<span class="op">=</span>[<span class="st">"date"</span>])</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># daily_agg = pd.read_csv("https://osf.io/download/jcxmk/", parse_dates=["date"])</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-the-vibe-check" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-vibe-check">ğŸ Bellondaâ€™s Decoder: The Vibe Check</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Never trust a clear pipeline. Always look at the first few rows to make sure the data loaded correctly and isnâ€™t garbage.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>.head()</code> | <strong>The Peek</strong> | â€œShow me the top 5 rows.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œVerifying data integrity.â€</p>
<div id="e4ec0311" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspecting the head</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>daily_agg.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">QUANTITY</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2010-01-01</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2010-01-02</td>
<td>49</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2010-01-03</td>
<td>31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2010-01-04</td>
<td>14</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2010-01-05</td>
<td>18</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="bellondas-decoder-the-butcher-shop-date-chopping" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-butcher-shop-date-chopping">ğŸ Bellondaâ€™s Decoder: The Butcher Shop (Date Chopping)</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We canâ€™t feed a raw date like â€œ2015-01-01â€ into a math model. It gets confused. We need to chop it up into pieces it understands: â€œItâ€™s a Thursdayâ€, â€œItâ€™s Januaryâ€, â€œItâ€™s 2015â€.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>.dt</code> | <strong>The Accessor</strong> | â€œUnlock the special time-travel methods for this column.â€ | | <code>.dt.dayofweek</code> | <strong>The Extraction</strong> | â€œGive me 0 for Monday, 6 for Sunday.â€ | | <code>.isin([6, 7])</code> | <strong>The Trap</strong> | â€œCheck if the value is INSIDE this list (Saturday or Sunday).â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œBreaking down the dates to analyze performance by day of week and month.â€</p>
<p><strong>4. ğŸŒ The Banana Peel (Watch Out!)</strong> &gt; [!WARNING] &gt; <strong>Donâ€™t slip here:</strong> <code>dayofweek</code> starts at 0 (Monday) in Python. If you think 1 is Monday, youâ€™re gonna have a bad time. Thatâ€™s why we added <code>+ 1</code>.</p>
</section>
<section id="bellondas-decoder-the-history-book" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-history-book">ğŸ Bellondaâ€™s Decoder: The History Book</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Now we look at the older data (2010-2014) to see if the pattern holds up over time. Consistency = Predictability.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>daily_agg.loc[...]</code> | <strong>The Filter</strong> | â€œSelect rows based on a condition (Year between 2010 and 2014).â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œReviewing historical trends.â€</p>
<div id="fd1e54ee" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting time components using the .dt accessor</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"year"</span>] <span class="op">=</span> daily_agg[<span class="st">"date"</span>].dt.year <span class="co"># The Year (e.g., 2015)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"quarter"</span>] <span class="op">=</span> daily_agg[<span class="st">"date"</span>].dt.quarter <span class="co"># The Quarter (1-4)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"month"</span>] <span class="op">=</span> daily_agg[<span class="st">"date"</span>].dt.month <span class="co"># The Month (1-12)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"day"</span>] <span class="op">=</span> daily_agg[<span class="st">"date"</span>].dt.day <span class="co"># The Day of the month (1-31)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"dow"</span>] <span class="op">=</span> daily_agg[<span class="st">"date"</span>].dt.dayofweek <span class="op">+</span> <span class="dv">1</span> <span class="co"># Day of Week (Mon=1, Sun=7)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Identifying Weekends: Is the day Saturday (6) or Sunday (7)?</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"weekend"</span>] <span class="op">=</span> daily_agg[<span class="st">"dow"</span>].isin([<span class="dv">6</span>, <span class="dv">7</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-the-logic-gate-complex-masks" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-logic-gate-complex-masks">ğŸ Bellondaâ€™s Decoder: The Logic Gate (Complex Masks)</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We need to flag specific days when schools are closed, because that affects swimming pool traffic. This isnâ€™t just â€œSummerâ€; itâ€™s a complex set of rules (Late May, August start, Winter break).</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>&amp;</code> | <strong>The AND</strong> | â€œBoth things must be true.â€ | | <code>|</code> | <strong>The OR</strong> | â€œAt least one thing must be true.â€ | | <code>( ... )</code> | <strong>The Guard Rails</strong> | â€œCRITICAL. You MUST use parentheses to group logic, or Python gets confused.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œIdentifying school holidays to adjust our forecasts.â€</p>
<p><strong>4. ğŸŒ The Banana Peel (Watch Out!)</strong> &gt; [!WARNING] &gt; <strong>Donâ€™t slip here:</strong> If you use the English words <code>and</code> / <code>or</code> here, Pandas will crash. You MUST use the bitwise operators <code>&amp;</code> / <code>|</code>.</p>
<div id="d330e0b7" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the "School Off" mask using Bitwise Logic (&amp;, |)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Parentheses are critical here to enforce order of operations!</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"school_off"</span>] <span class="op">=</span> (</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    ((daily_agg[<span class="st">"day"</span>] <span class="op">&gt;</span> <span class="dv">15</span>) <span class="op">&amp;</span> (daily_agg[<span class="st">"month"</span>] <span class="op">==</span> <span class="dv">5</span>) <span class="op">&amp;</span> (daily_agg[<span class="st">"day"</span>] <span class="op">&lt;=</span> <span class="dv">30</span>)) <span class="co"># Late May</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> ((daily_agg[<span class="st">"month"</span>] <span class="op">==</span> <span class="dv">6</span>) <span class="op">|</span> (daily_agg[<span class="st">"month"</span>] <span class="op">==</span> <span class="dv">7</span>)) <span class="co"># June or July (Support Summer)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> ((daily_agg[<span class="st">"day"</span>] <span class="op">&lt;</span> <span class="dv">15</span>) <span class="op">&amp;</span> (daily_agg[<span class="st">"month"</span>] <span class="op">==</span> <span class="dv">8</span>)) <span class="co"># Early August</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> ((daily_agg[<span class="st">"day"</span>] <span class="op">&gt;</span> <span class="dv">20</span>) <span class="op">&amp;</span> (daily_agg[<span class="st">"month"</span>] <span class="op">==</span> <span class="dv">12</span>)) <span class="co"># Late December (Winter Break)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-the-arrow-of-time" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-arrow-of-time">ğŸ Bellondaâ€™s Decoder: The Arrow of Time</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Time usually moves forward (unless you are a Time Lord). We create a simple counter (<code>1, 2, 3...</code>) to represent this linear progression, which helps models capture â€œGrowthâ€ over time.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>.index + 1</code> | <strong>The Counter</strong> | â€œUse the row numbers as a proxy for time.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œAdding a trend line to see if sales are generally going up or down.â€</p>
<div id="c8f5a511" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a simple linear trend for time</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"trend"</span>] <span class="op">=</span> daily_agg.index <span class="op">+</span> <span class="dv">1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f7a2d8f9" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get holiday calendar ----------------------------------</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-cheating-with-external-data" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-cheating-with-external-data">ğŸ Bellondaâ€™s Decoder: Cheating with External Data</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> The swimming pool is closed on holidays. We <em>could</em> type out every holiday manually, but thatâ€™s dumb. we use a library (<code>pandas_market_calendars</code>) to pull the NYSE holiday list. If the bankers are off, the kids are swimming.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>mcal.get_calendar("NYSE")</code> | <strong>The Source</strong> | â€œDownload the Wall Street schedule.â€ | | <code>.isin(holidays)</code> | <strong>The Cross-ref</strong> | â€œCheck if our dates appear in that holiday list.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œIntegrating public holiday data to account for closures.â€</p>
<div id="16c065f8" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nyse <span class="op">=</span> mcal.get_calendar(<span class="st">"NYSE"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>holidays <span class="op">=</span> nyse.holidays().holidays</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"isHoliday"</span>] <span class="op">=</span> daily_agg[<span class="st">"date"</span>].isin(holidays)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-the-10000-foot-view" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-10000-foot-view">ğŸ Bellondaâ€™s Decoder: The 10,000 Foot View</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Before we build fancy models, we look at the basic stats. Averages, max, min. If the max ticket sales is 1 million, we know something is wrong.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>.describe()</code> | <strong>The Summary</strong> | â€œCalculate count, mean, std, min, max for every column.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œChecking the summary statistics.â€</p>
<div id="430fbf7b" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A quick glance at the numerical summaries (Distribution Check)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>daily_agg.describe()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">QUANTITY</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">dow</th>
<th data-quarto-table-cell-role="th">trend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">count</th>
<td>2557</td>
<td>2557.000000</td>
<td>2557.000000</td>
<td>2557.000000</td>
<td>2557.000000</td>
<td>2557.000000</td>
<td>2557.000000</td>
<td>2557.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">mean</th>
<td>2013-07-02 00:00:00</td>
<td>47.867032</td>
<td>2013.000782</td>
<td>2.508408</td>
<td>6.522487</td>
<td>15.730935</td>
<td>4.001173</td>
<td>1279.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">min</th>
<td>2010-01-01 00:00:00</td>
<td>0.000000</td>
<td>2010.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25%</th>
<td>2011-10-02 00:00:00</td>
<td>14.000000</td>
<td>2011.000000</td>
<td>2.000000</td>
<td>4.000000</td>
<td>8.000000</td>
<td>2.000000</td>
<td>640.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">50%</th>
<td>2013-07-02 00:00:00</td>
<td>28.000000</td>
<td>2013.000000</td>
<td>3.000000</td>
<td>7.000000</td>
<td>16.000000</td>
<td>4.000000</td>
<td>1279.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">75%</th>
<td>2015-04-02 00:00:00</td>
<td>64.000000</td>
<td>2015.000000</td>
<td>4.000000</td>
<td>10.000000</td>
<td>23.000000</td>
<td>6.000000</td>
<td>1918.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">max</th>
<td>2016-12-31 00:00:00</td>
<td>287.000000</td>
<td>2016.000000</td>
<td>4.000000</td>
<td>12.000000</td>
<td>31.000000</td>
<td>7.000000</td>
<td>2557.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">std</th>
<td>NaN</td>
<td>50.491050</td>
<td>2.000587</td>
<td>1.117346</td>
<td>3.449499</td>
<td>8.802361</td>
<td>2.000097</td>
<td>738.286643</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="define-vars-for-analysis" class="level3">
<h3 class="anchored" data-anchor-id="define-vars-for-analysis">Define vars for analysis</h3>
</section>
<section id="bellondas-decoder-the-broadcaster-transform" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-broadcaster-transform">ğŸ Bellondaâ€™s Decoder: The Broadcaster (Transform)</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> This is a pro move. We want to know the <em>average</em> sales for â€œJanuaryâ€ but we want to stick that number next to <em>every single day</em> in January. This allows us to compare â€œTodayâ€ vs â€œTypical Dayâ€.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>.groupby("month")</code> | <strong>The Buckets</strong> | â€œPut all Januaries in one bucket, all Februaries in another.â€ | | <code>.transform("mean")</code> | <strong>The Broadcaster</strong> | â€œCalculate the mean for the bucket, then <em>broadcast</em> it back to every original row.â€ | | <code>np.log()</code> | <strong>The Squasher</strong> | â€œCompress large numbers to reduce the effect of massive outliers.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œCalculating seasonal baselines (monthly and weekly patterns).â€</p>
<p><strong>4. ğŸŒ The Banana Peel (Watch Out!)</strong> &gt; [!WARNING] &gt; <strong>Donâ€™t slip here:</strong> standard <code>.mean()</code> shrinks your data to 12 rows. <code>.transform("mean")</code> keeps it at N rows. Use the right one!</p>
<div id="19f2961d" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Monthly Seasonality (Mean Quantity per Month)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">'q_month'</span>] <span class="op">=</span> daily_agg.groupby(<span class="st">'month'</span>)[<span class="st">'QUANTITY'</span>].transform(<span class="st">'mean'</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Log Transformation (Stabilizing the Variance)</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">'q_ln'</span>] <span class="op">=</span> np.log(daily_agg[<span class="st">'QUANTITY'</span>])</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Handling the Void (Inf/-Inf): Replace infinite values with NaN so they don't break the model</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">'q_ln'</span>] <span class="op">=</span> daily_agg[<span class="st">'q_ln'</span>].replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Weekly Seasonality within Months (Mean Quantity per Month-DayOfWeek combination)</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">'tickets'</span>] <span class="op">=</span> daily_agg.groupby([<span class="st">'month'</span>, <span class="st">'dow'</span>])[<span class="st">'QUANTITY'</span>].transform(<span class="st">'mean'</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Log Version of Weekly Seasonality</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">'tickets_ln'</span>] <span class="op">=</span> daily_agg.groupby([<span class="st">'month'</span>, <span class="st">'dow'</span>])[<span class="st">'q_ln'</span>].transform(<span class="st">'mean'</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Abbreviations for visualization (e.g., 'Mon', 'Jan')</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">'dow_abb'</span>] <span class="op">=</span> daily_agg[<span class="st">'date'</span>].dt.day_name().<span class="bu">str</span>[:<span class="dv">3</span>]</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">'month_abb'</span>] <span class="op">=</span> daily_agg[<span class="st">'date'</span>].dt.month_name().<span class="bu">str</span>[:<span class="dv">3</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="descriptive-graphs" class="level2">
<h2 class="anchored" data-anchor-id="descriptive-graphs">Descriptive graphs</h2>
<section id="bellondas-decoder-the-microscope" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-microscope">ğŸ Bellondaâ€™s Decoder: The Microscope</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> If we plot all 5 years, it looks like a mess. We zoom in on one year (2015) to see the heartbeat of the businessâ€”the weekly cycles.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>sns.lineplot()</code> | <strong>The Artist</strong> | â€œDraw a line connecting the dots.â€ | | <code>plt.xticks()</code> | <strong>The Labels</strong> | â€œForce the X-axis to show readable dates instead of random numbers.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œVisualizing the daily sales rhythm for 2015.â€</p>
<div id="79e30dd6" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Focusing on a single year (2015) to see the daily rhythm</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="op">=</span> daily_agg[daily_agg[<span class="st">"year"</span>] <span class="op">==</span> <span class="dv">2015</span>].reset_index()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Drawing the line of time</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>filtered_data, x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"QUANTITY"</span>, linewidth<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibrating the X-Axis labels (The tick marks)</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>date_ticks <span class="op">=</span> [<span class="st">"2015-01-01"</span>, <span class="st">"2015-04-01"</span>, <span class="st">"2015-07-01"</span>, <span class="st">"2015-10-01"</span>, <span class="st">"2016-01-01"</span>]</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>plt.xticks(date_ticks, [pd.to_datetime(date).strftime(<span class="st">"</span><span class="sc">%d</span><span class="st">%b%Y"</span>) <span class="cf">for</span> date <span class="kw">in</span> date_ticks])</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Labelling the axes for the observer</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date (day)"</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily ticket sales"</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ch18-swimmingpool-predict-bellonda_from-qmd_files/figure-html/cell-14-output-1.png" width="611" height="472" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bellondas-decoder-the-history-book-1" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-history-book-1">ğŸ Bellondaâ€™s Decoder: The History Book</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Now we look at the older data (2010-2014) to see if the pattern holds up over time. Consistency = Predictability.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>daily_agg.loc[...]</code> | <strong>The Filter</strong> | â€œSelect rows based on a condition (Year between 2010 and 2014).â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œReviewing historical trends.â€</p>
<div id="13311197" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="op">=</span> daily_agg.loc[</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    (daily_agg.year <span class="op">&gt;=</span> <span class="dv">2010</span>) <span class="op">&amp;</span> (daily_agg.year <span class="op">&lt;=</span> <span class="dv">2014</span>), :</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>].reset_index()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>filtered_data, x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"QUANTITY"</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>date_ticks <span class="op">=</span> [</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2010-01-01"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2011-01-01"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2012-01-01"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2013-01-01"</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2014-01-01"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2015-01-01"</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>plt.xticks(date_ticks, [pd.to_datetime(date).strftime(<span class="st">"</span><span class="sc">%d</span><span class="st">%b%Y"</span>) <span class="cf">for</span> date <span class="kw">in</span> date_ticks])</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date (day)"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily ticket sales"</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ch18-swimmingpool-predict-bellonda_from-qmd_files/figure-html/cell-15-output-1.png" width="610" height="476" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bellondas-decoder-the-box-of-truth" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-box-of-truth">ğŸ Bellondaâ€™s Decoder: The Box of Truth</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> A line plot shows trends, but a Box Plot shows <em>variability</em>. We want to see: Are sales consistent in June, or do they fluctuate wildly?</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>sns.boxplot()</code> | <strong>The Chart</strong> | â€œDraw the distribution (Median, Quartiles, Outliers).â€ | | <code>fliersize</code> | <strong>The Diamonds</strong> | â€œHow big should the outlier dots be?â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œAnalyzing monthly sales volatility.â€</p>
<div id="ef5ef4a1" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining the Order: We force the months to align with the calendar, not the alphabet</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>month_order <span class="op">=</span> [</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Jan"</span>, <span class="st">"Feb"</span>, <span class="st">"Mar"</span>, <span class="st">"Apr"</span>, <span class="st">"May"</span>, <span class="st">"Jun"</span>, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Jul"</span>, <span class="st">"Aug"</span>, <span class="st">"Sep"</span>, <span class="st">"Oct"</span>, <span class="st">"Nov"</span>, <span class="st">"Dec"</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Summoning the Box Plot</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>sns.boxplot(</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>daily_agg,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"month_abb"</span>, <span class="co"># Grouping by Month</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"QUANTITY"</span>, <span class="co"># analyzing Ticket Sales</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    fliersize<span class="op">=</span><span class="dv">3</span>, <span class="co"># Size of the outlier diamonds</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    order<span class="op">=</span>month_order, <span class="co"># Enforcing our custom order</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    flierprops<span class="op">=</span>{</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"markerfacecolor"</span>: da.color[<span class="dv">3</span>], <span class="co"># coloring the outliers</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"markeredgecolor"</span>: da.color[<span class="dv">3</span>],</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alpha"</span>: <span class="fl">0.6</span>,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    boxprops<span class="op">=</span>{<span class="st">"facecolor"</span>: <span class="st">"white"</span>, <span class="st">"edgecolor"</span>: da.color[<span class="dv">0</span>]},</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    whiskerprops<span class="op">=</span>{<span class="st">"color"</span>: da.color[<span class="dv">0</span>]},</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    medianprops<span class="op">=</span>{<span class="st">"color"</span>: da.color[<span class="dv">0</span>], <span class="st">"linewidth"</span>: <span class="dv">2</span>},</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    showcaps<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>plt.yticks(np.arange(<span class="dv">0</span>, <span class="dv">400</span>, <span class="dv">100</span>)) <span class="co"># Calibrating the Y-axis</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date (month)"</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily ticket sales"</span>)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">"x"</span>, color<span class="op">=</span><span class="st">"gray"</span>, linestyle<span class="op">=</span><span class="st">"-"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>) <span class="co"># Adding a grid for precision</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:matplotlib.category:Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.
INFO:matplotlib.category:Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ch18-swimmingpool-predict-bellonda_from-qmd_files/figure-html/cell-16-output-2.png" width="597" height="476" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bellondas-decoder-the-weekly-grind" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-weekly-grind">ğŸ Bellondaâ€™s Decoder: The Weekly Grind</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Same as above, but for Days of the Week. Is Monday dead? Is Sunday crazy? This confirms our weekly seasonality assumption.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>order=dow_order</code> | <strong>The Sorter</strong> | â€œForce the days to appear Mon-&gt;Sun, not alphabetically (Fri-&gt;Mon).â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œAnalyzing weekly sales volatility.â€</p>
<div id="6d5aeadc" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining the Order of Days (Monday first!)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>dow_order <span class="op">=</span> [<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>, <span class="st">"Sat"</span>, <span class="st">"Sun"</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Summoning the Box Plot for Days of the Week</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>sns.boxplot(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>daily_agg,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"dow_abb"</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"QUANTITY"</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    fliersize<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    order<span class="op">=</span>dow_order,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    flierprops<span class="op">=</span>{</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"markerfacecolor"</span>: da.color[<span class="dv">3</span>],</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"markeredgecolor"</span>: da.color[<span class="dv">3</span>],</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alpha"</span>: <span class="fl">0.6</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    boxprops<span class="op">=</span>{<span class="st">"facecolor"</span>: <span class="st">"white"</span>, <span class="st">"edgecolor"</span>: da.color[<span class="dv">0</span>]},</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    whiskerprops<span class="op">=</span>{<span class="st">"color"</span>: da.color[<span class="dv">0</span>]},</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    medianprops<span class="op">=</span>{<span class="st">"color"</span>: da.color[<span class="dv">0</span>], <span class="st">"linewidth"</span>: <span class="dv">2</span>},</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    showcaps<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>plt.yticks(np.arange(<span class="dv">0</span>, <span class="dv">400</span>, <span class="dv">100</span>))</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Day of the week"</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily ticket sales"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">"x"</span>, color<span class="op">=</span><span class="st">"gray"</span>, linestyle<span class="op">=</span><span class="st">"-"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:matplotlib.category:Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.
INFO:matplotlib.category:Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ch18-swimmingpool-predict-bellonda_from-qmd_files/figure-html/cell-17-output-2.png" width="597" height="476" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bellondas-decoder-thermal-vision" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-thermal-vision">ğŸ Bellondaâ€™s Decoder: Thermal Vision</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We want to see the interaction between Month and Day. Are Sundays in July hotter than Sundays in December? A heatmap visualizes this 2D grid instantly.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>pd.Categorical(ordered=True)</code> | <strong>The Enforcer</strong> | â€œTell Python that â€˜Januaryâ€™ comes before â€˜Februaryâ€™, logically.â€ | | <code>.pivot()</code> | <strong>The Matrix</strong> | â€œReshape data so Rows=Month, Columns=Day, Values=Sales.â€ | | <code>sns.heatmap()</code> | <strong>The IR Goggles</strong> | â€œColor the cells based on value (Dark=Low, Light=High).â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€ identifying high-traffic hotspots.â€</p>
<p><strong>4. ğŸŒ The Banana Peel (Watch Out!)</strong> &gt; [!WARNING] &gt; <strong>Donâ€™t slip here:</strong> If you donâ€™t use <code>ordered=True</code>, your heatmap axis will be alphabetical (Apr, Aug, Decâ€¦) which makes the seasonality impossible to read.</p>
<div id="e524961f" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to check for interactions, look at the heatmap</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Enforcing Order on the Dimensions</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"dow_abb_ordered"</span>] <span class="op">=</span> pd.Categorical(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    daily_agg[<span class="st">"dow_abb"</span>], categories<span class="op">=</span>dow_order, ordered<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>daily_agg[<span class="st">"month_abb_ordered"</span>] <span class="op">=</span> pd.Categorical(</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    daily_agg[<span class="st">"month_abb"</span>], categories<span class="op">=</span><span class="bu">reversed</span>(month_order), ordered<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregating: Calculating Mean Tickets for each (Month, Day) pair</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>agg_data <span class="op">=</span> daily_agg.groupby([<span class="st">"month_abb_ordered"</span>, <span class="st">"dow_abb_ordered"</span>], as_index<span class="op">=</span><span class="va">False</span>)[</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tickets"</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>].mean()</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivoting: The Transformation to Matrix Form</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>heatmap_data <span class="op">=</span> agg_data.pivot(</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"month_abb_ordered"</span>, columns<span class="op">=</span><span class="st">"dow_abb_ordered"</span>, values<span class="op">=</span><span class="st">"tickets"</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Summoning the Heatmap</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>sns.heatmap(</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    heatmap_data,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"viridis_r"</span>, <span class="co"># The color palette (Reversed Viridis)</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    linewidths<span class="op">=</span><span class="fl">0.5</span>, <span class="co"># Grid lines</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    linecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    cbar_kws<span class="op">=</span>{<span class="st">"shrink"</span>: <span class="fl">0.4</span>, <span class="st">"aspect"</span>: <span class="dv">5</span>}, <span class="co"># Configuring the Legend Bar</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Day of the week"</span>)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Month"</span>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>) <span class="co"># Keeping Y-labels horizontal for readability</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjusting the Color Bar (The Scale of Magic)</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.gca().collections[<span class="dv">0</span>].colorbar</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>cbar.ax.tick_params(labelsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>cbar.set_label(<span class="st">"Tickets"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>cbar.set_ticks([<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>])</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ch18-swimmingpool-predict-bellonda_from-qmd_files/figure-html/cell-18-output-1.png" width="736" height="509" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bellondas-decoder-thermal-vision-log-scale" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-thermal-vision-log-scale">ğŸ Bellondaâ€™s Decoder: Thermal Vision (Log Scale)</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Same heatmap, but using Log-sales. This dampens the extreme peaks and lets us see differences in the â€œquietâ€ months more clearly.</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œSame analysis, adjusted for scale.â€</p>
<div id="8c2ef38a" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># not in book</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeating the Spell for Log-Transformed Data</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>agg_data <span class="op">=</span> daily_agg.groupby([<span class="st">"month_abb_ordered"</span>, <span class="st">"dow_abb_ordered"</span>], as_index<span class="op">=</span><span class="va">False</span>)[</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tickets_ln"</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>].mean()</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>heatmap_data <span class="op">=</span> agg_data.pivot(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"month_abb_ordered"</span>, columns<span class="op">=</span><span class="st">"dow_abb_ordered"</span>, values<span class="op">=</span><span class="st">"tickets_ln"</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>sns.heatmap(</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    heatmap_data,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"viridis_r"</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    linewidths<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    linecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    cbar_kws<span class="op">=</span>{<span class="st">"shrink"</span>: <span class="fl">0.4</span>, <span class="st">"aspect"</span>: <span class="dv">5</span>, <span class="st">"label"</span>: <span class="st">"Log tickets"</span>},</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Day of the week"</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Month"</span>)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.gca().collections[<span class="dv">0</span>].colorbar</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>cbar.ax.tick_params(labelsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ch18-swimmingpool-predict-bellonda_from-qmd_files/figure-html/cell-19-output-1.png" width="724" height="509" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="prediction" class="level2">
<h2 class="anchored" data-anchor-id="prediction">Prediction</h2>
<section id="creat-trainholdout-data" class="level3">
<h3 class="anchored" data-anchor-id="creat-trainholdout-data">Creat train/holdout data</h3>
</section>
<section id="bellondas-decoder-the-time-travel-ban" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-time-travel-ban">ğŸ Bellondaâ€™s Decoder: The Time Travel Ban</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We need to test our model. In normal Machine Learning, we shuffle the data randomly. In Time Series, <strong>WE DO NOT SHUFFLE</strong>. Because if you train on data from tomorrow to predict yesterday, you are cheating. Itâ€™s called â€œLook-ahead Biasâ€.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>factor_cols</code> | <strong>The Prep</strong> | â€œConvert these columns to Categories (Factors) so the model treats them as groups, not numbers.â€ | | <code>.loc[year &lt; 2016]</code> | <strong>The Split</strong> | â€œKeep everything BEFORE 2016 for training.â€ | | <code>.loc[year == 2016]</code> | <strong>The Holdout</strong> | â€œKeep 2016 locked away in a vault. We only touch this ONCE at the very end.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œSplitting data into â€˜Pastâ€™ (Training) and â€˜Futureâ€™ (Testing) to simulate a real-world scenario.â€</p>
<p><strong>4. ğŸŒ The Banana Peel (Watch Out!)</strong> &gt; [!WARNING] &gt; <strong>Donâ€™t slip here:</strong> If you use <code>train_test_split(shuffle=True)</code>, your boss will fire you for delivering impossible accuracy.</p>
<div id="7b767031" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Preparing the Factor columns (Categories)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>factor_cols <span class="op">=</span> [<span class="st">"month"</span>, <span class="st">"dow"</span>, <span class="st">"isHoliday"</span>, <span class="st">"school_off"</span>]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>daily_agg[factor_cols] <span class="op">=</span> daily_agg[factor_cols].astype(<span class="st">"category"</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. The Holdout Set (The Future: 2016)</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>data_holdout <span class="op">=</span> daily_agg.loc[daily_agg[<span class="st">"year"</span>] <span class="op">==</span> <span class="dv">2016</span>, :]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. The Training Set (The Past: 2010-2015)</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>data_train <span class="op">=</span> daily_agg.loc[daily_agg[<span class="st">"year"</span>] <span class="op">&lt;</span> <span class="dv">2016</span>, :]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-the-custom-gauntlet-rolling-cv" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-custom-gauntlet-rolling-cv">ğŸ Bellondaâ€™s Decoder: The Custom Gauntlet (Rolling CV)</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Standard Cross-Validation functions are dumb about time. We need to build a custom loop that respects history. We train on Years A, B, C, D to predict Year E. Then we rotate.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>def function_name(...):</code> | <strong>The Blueprint</strong> | â€œWe are creating a reusable tool.â€ | | <code>yield</code> or <code>append</code> | <strong>The Collection</strong> | â€œStore the score for this year, then move to the next.â€ | | <code>correct_log_...</code> | <strong>The Math Hack</strong> | â€œIf we predicted log-sales, convert them back to real-sales so the boss understands the error.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œStress-testing the model across different historical years to ensure reliability.â€</p>
<div id="7f64cc9d" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Frieren: A custom spell to iterate through time periods</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inserted_test_set_cv(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    formula: <span class="bu">str</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    data: pd.DataFrame,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    group_col: <span class="bu">str</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    correct_log_transformation_bias: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Perform inserted test set cross-validation.</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Input Parsing: Extracting the target variable name (Left side of ~)</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    y_variable <span class="op">=</span> formula.split(<span class="st">"~"</span>)[<span class="dv">0</span>].strip()</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Cleaning: Dropping missing values in the target to avoid errors</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data.dropna(subset<span class="op">=</span>[y_variable])</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Identifying the Epochs (Years) to iterate over</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    test_sets <span class="op">=</span> data[group_col].unique()</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    rmse_folds <span class="op">=</span> [] <span class="co"># The Accumulator for our results</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. The Loop of Time</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> test_set <span class="kw">in</span> test_sets:</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define Training Data: Everything EXCEPT the current test year</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        data_train <span class="op">=</span> data.loc[data[group_col] <span class="op">!=</span> test_set, :]</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define Test Data: ONLY the current test year</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        data_test <span class="op">=</span> data.loc[data[group_col] <span class="op">==</span> test_set, :]</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 5. Training the Model (Fitting the spell)</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> pf.feols(formula, data<span class="op">=</span>data_train)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 6. Forecasting</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>        y_hat <span class="op">=</span> model.predict(data_test)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> data_test[y_variable]</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 7. Evaluating Accuracy (RMSE)</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> root_mean_squared_error(y_true, y_hat)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 8. Correction for Log-Models (If we predicted log(y), we must convert back)</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> correct_log_transformation_bias:</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Applying the correction factor exp(sigma^2 / 2)</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>            y_hat <span class="op">=</span> np.exp(y_hat) <span class="op">*</span> np.exp(rmse<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>            y_true <span class="op">=</span> np.exp(y_true)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Re-calculating RMSE in the original scale</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>            rmse <span class="op">=</span> root_mean_squared_error(y_true, y_hat)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Storing the result</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>        rmse_folds.append(rmse)</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Frieren: aggregating the shards of time into a single truth (Mean Probability)</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean(rmse_folds)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-the-formula-book" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-formula-book">ğŸ Bellondaâ€™s Decoder: The Formula Book</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We donâ€™t know which combination of variables works best. So we define 5 candidates, ranging from â€œStupid Simpleâ€ (Model 1) to â€œGalaxy Brainâ€ (Model 5).</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>"y ~ x1 + x2"</code> | <strong>The Recipe</strong> | â€œPredict Y using ingredients X1 and X2.â€ | | <code>*</code> (e.g., <code>school_off*dow</code>) | <strong>The Interaction</strong> | â€œCheck if â€˜School Offâ€™ has a <em>different</em> impact on Mondays vs Fridays.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œHypothesizing different drivers of sales (Holidays vs Trends vs Seasonality).â€</p>
<div id="ce52df19" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining the complexity tiers</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 1: The Simplest Spell (Linear Trend + Month)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>model1 <span class="op">=</span> <span class="st">"QUANTITY ~ trend + month"</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2: Adding Weekly Rhythms (+ Day of Week)</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>model2 <span class="op">=</span> <span class="st">"QUANTITY ~ trend + month + dow"</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 3: Injecting External Knowledge (+ Holidays)</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>model3 <span class="op">=</span> <span class="st">"QUANTITY ~ trend + month + dow + isHoliday"</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 4: Handling Special Events (+ School Off Interaction)</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: 'school_off*dow' adds both the main effect and the interaction</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>model4 <span class="op">=</span> <span class="st">"QUANTITY ~ trend + month + dow + isHoliday + school_off*dow"</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 5: The Grand Arch-Mage Spell (Full Complexity)</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding interactions between Weekend and Month (Summer weekends vs Winter weekends)</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>model5 <span class="op">=</span> <span class="st">"QUANTITY ~ trend + month + dow + isHoliday + school_off*dow + weekend*month"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-the-tournament" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-tournament">ğŸ Bellondaâ€™s Decoder: The Tournament</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We have 5 gladiators (Models). We throw them into the arena (The Cross-Validation Loop). Only one survives.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>for model in [...]</code> | <strong>The Loop</strong> | â€œExecute the test for every candidate.â€ | | <code>cross_validated_rmses.append()</code> | <strong>The Scoreboard</strong> | â€œWrite down the error score.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œBenchmarking our models against each other.â€</p>
<div id="e3b696c9" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The Evaluation Ritual: Testing each spell against the flow of time</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>cross_validated_rmses <span class="op">=</span> []</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model <span class="kw">in</span> [model1, model2, model3, model4, model5]:</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Running the Temporal Cross-Validation</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> inserted_test_set_cv(model, data_train, <span class="st">"year"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    cross_validated_rmses.append(rmse)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-the-logarithmic-twist" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-logarithmic-twist">ğŸ Bellondaâ€™s Decoder: The Logarithmic Twist</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Ticket sales canâ€™t be negative, and they might grow exponentially. A linear model assumes straight lines. By taking the <code>log()</code> of sales, we make the curve straight, fit the model, and then bend it back at the end.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>q_ln ~ ...</code> | <strong>The Target</strong> | â€œPredict the Log-Quantity, not the Quantity.â€ | | <code>correct_log...=True</code> | <strong>The Fix</strong> | â€œApply the special math correction when converting back.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œTesting a specialized model for exponential growth.â€</p>
<div id="0980c2f5" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 6: The Logarithmic Alteration</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Sometimes mana flows exponentially. We take the log() to make it linear.</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>model6 <span class="op">=</span> <span class="st">"q_ln ~ trend + month + dow + isHoliday + school_off*dow"</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We must fix the bias when converting back from Log-World to Real-World</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>rmse6 <span class="op">=</span> inserted_test_set_cv(</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    model6, data_train, <span class="st">"year"</span>, correct_log_transformation_bias<span class="op">=</span><span class="va">True</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>cross_validated_rmses.append(rmse6)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="use-prophet-prediction" class="level3">
<h3 class="anchored" data-anchor-id="use-prophet-prediction">Use prophet prediction</h3>
</section>
<section id="bellondas-decoder-summoning-the-oracle-prophet" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-summoning-the-oracle-prophet">ğŸ Bellondaâ€™s Decoder: Summoning the Oracle (Prophet)</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Facebook built a forecasting tool called Prophet. Itâ€™s famous. We are importing it to see if Zuckerbergâ€™s AI is smarter than our simple regression.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>Prophet()</code> | <strong>The Factory</strong> | â€œCreate a new forecasting engine.â€ | | <code>yearly_seasonality='auto'</code> | <strong>The Autopilot</strong> | â€œFigure out the patterns yourself, robot.â€ | | <code>add_country_holidays</code> | <strong>The Cheat Code</strong> | â€œAutomatically look up US holidays.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œComparing our custom model against an industry-standard AI tool.â€</p>
<p><strong>4. ğŸŒ The Banana Peel (Watch Out!)</strong> &gt; [!WARNING] &gt; <strong>Donâ€™t slip here:</strong> Prophet is strict. You MUST rename your columns to <code>ds</code> (Date) and <code>y</code> (Value), or it will error out.</p>
<div id="818dec5a" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophet <span class="im">import</span> Prophet</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophet.diagnostics <span class="im">import</span> cross_validation</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophet.diagnostics <span class="im">import</span> performance_metrics</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5b08b36b" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Frieren: Initializing the Oracle. Note 'additive' seasonality.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>model_prophet <span class="op">=</span> Prophet(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    seasonality_mode<span class="op">=</span><span class="st">"additive"</span>, <span class="co"># Adding effects (Trend + Season + Holiday)</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    yearly_seasonality<span class="op">=</span><span class="st">"auto"</span>, <span class="co"># Detecting annual cycles automatically</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    weekly_seasonality<span class="op">=</span><span class="st">"auto"</span>, <span class="co"># Detecting weekly cycles</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    growth<span class="op">=</span><span class="st">"linear"</span>, <span class="co"># Assuming linear growth over time</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    daily_seasonality<span class="op">=</span><span class="va">True</span>, <span class="co"># Accounting for daily patterns</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Injecting the knowledge of US Holidays into the Oracle</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>model_prophet <span class="op">=</span> Prophet.add_country_holidays(model_prophet, <span class="st">"US"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bellondas-decoder-training-the-oracle" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-training-the-oracle">ğŸ Bellondaâ€™s Decoder: Training the Oracle</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We have to feed the data to Prophet. Itâ€™s a hungry beast.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>.rename()</code> | <strong>The Uniform</strong> | â€œPut on the â€˜dsâ€™ and â€˜yâ€™ name tags so Prophet recognizes you.â€ | | <code>.fit()</code> | <strong>The Learning</strong> | â€œAnalyze the history.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œTraining the AI model.â€</p>
<div id="5eab9faf" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting the Oracle to the Past</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>model_prophet <span class="op">=</span> Prophet.fit(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    model_prophet,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Frieren: The Oracle demands 'ds' and 'y' columns. We must comply.</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    df<span class="op">=</span>data_train[[<span class="st">"date"</span>, <span class="st">"QUANTITY"</span>]].rename({<span class="st">"date"</span>: <span class="st">"ds"</span>, <span class="st">"QUANTITY"</span>: <span class="st">"y"</span>}, axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:cmdstanpy:Chain [1] start processing
INFO:cmdstanpy:Chain [1] done processing</code></pre>
</div>
</div>
</section>
<section id="bellondas-decoder-the-oracles-test" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-oracles-test">ğŸ Bellondaâ€™s Decoder: The Oracleâ€™s Test</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Prophet has its own way of doing cross-validation. It simulates â€œstanding in the pastâ€ and forecasting forward.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>initial='365 days'</code> | <strong>The Start</strong> | â€œTrain on year 1.â€ | | <code>horizon='365 days'</code> | <strong>The Goal</strong> | â€œPredict year 2.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œBacktesting the AI performance.â€</p>
<div id="b6a3f288" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generating the Cross-Validation folds (Temporal Backtesting)</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>cv_pred <span class="op">=</span> cross_validation(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    model_prophet, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    initial<span class="op">=</span><span class="st">"365 days"</span>, <span class="co"># Training on at least 1 year</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    period<span class="op">=</span><span class="st">"365 days"</span>, <span class="co"># Moving forward by 1 year at a time</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    horizon<span class="op">=</span><span class="st">"365 days"</span> <span class="co"># Predicting 1 year into the future</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:prophet:Making 5 forecasts with cutoffs between 2011-01-01 00:00:00 and 2014-12-31 00:00:00
WARNING:prophet:Seasonality has period of 365.25 days which is larger than initial window. Consider increasing initial.</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a3b327bc48114fa6bd6b58acbf8c8fe9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:cmdstanpy:Chain [1] start processing
INFO:cmdstanpy:Chain [1] done processing
INFO:cmdstanpy:Chain [1] start processing
INFO:cmdstanpy:Chain [1] done processing
INFO:cmdstanpy:Chain [1] start processing
INFO:cmdstanpy:Chain [1] done processing
INFO:cmdstanpy:Chain [1] start processing
INFO:cmdstanpy:Chain [1] done processing
INFO:cmdstanpy:Chain [1] start processing
INFO:cmdstanpy:Chain [1] done processing</code></pre>
</div>
</div>
</section>
<section id="bellondas-decoder-grading-the-oracle" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-grading-the-oracle">ğŸ Bellondaâ€™s Decoder: Grading the Oracle</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Prophet spits out a complex table. We just want one number: The RMSE (Error score).</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>performance_metrics</code> | <strong>The Grader</strong> | â€œCalculate accuracy scores.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œGetting the final score for the AI model.â€</p>
<div id="78897065" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting the RMSE from the Oracle's visions</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>rmse_prophet_cv <span class="op">=</span> performance_metrics(cv_pred, rolling_window<span class="op">=</span><span class="dv">1</span>)[<span class="st">"rmse"</span>].values[<span class="dv">0</span>]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>cross_validated_rmses.append(rmse_prophet_cv)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:prophet:Skipping MAPE because y close to 0</code></pre>
</div>
</div>
</section>
<section id="bellondas-decoder-the-scoreboard" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-scoreboard">ğŸ Bellondaâ€™s Decoder: The Scoreboard</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We have 7 candidates now (5 Linear, 1 Log, 1 Prophet). Who won? Lowest RMSE takes the crown.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>pd.DataFrame()</code> | <strong>The Report</strong> | â€œMake a nice table of the results.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œFinal model selection based on accuracy.â€</p>
<div id="10435909" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: M6 log model rmse is slightly different from book</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    cross_validated_rmses,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"M"</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>)] <span class="op">+</span> [<span class="st">"M6 (log)"</span>, <span class="st">"M7 (Prophet)"</span>],</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"RMSE"</span>],</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>).<span class="bu">round</span>(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">M1</th>
<td>32.34787</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">M2</th>
<td>31.44848</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">M3</th>
<td>31.45826</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">M4</th>
<td>27.60475</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">M5</th>
<td>26.90412</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">M6 (log)</th>
<td>30.20278</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">M7 (Prophet)</th>
<td>29.44663</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="evaluate-best-model-on-holdout-set" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-best-model-on-holdout-set">Evaluate best model on holdout set</h2>
<section id="bellondas-decoder-the-final-exam" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-final-exam">ğŸ Bellondaâ€™s Decoder: The Final Exam</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We picked a winner (Model 5). Now, for the first time ever, we introduce it to 2016 (Holdout Data). This is the true test of real-world performance.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>.predict(data_holdout)</code> | <strong>The Forecast</strong> | â€œGenerate predictions for the future.â€ | | <code>root_mean_squared_error</code> | <strong>The Grade</strong> | â€œHow far off were we?â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œConfirming model reliability on fresh data before deployment.â€</p>
<div id="3af48708" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> pf.feols(model5, data<span class="op">=</span>data_train)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>data_holdout[<span class="st">"y_hat_5"</span>] <span class="op">=</span> best_model.predict(data_holdout)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="247a8b8d" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>rmse_holdout_best <span class="op">=</span> root_mean_squared_error(data_holdout.QUANTITY, data_holdout.y_hat_5)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>rmse_holdout_best</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>24.577496175561176</code></pre>
</div>
</div>
</section>
<section id="plot-best-predictions" class="level3">
<h3 class="anchored" data-anchor-id="plot-best-predictions">Plot best predictions</h3>
</section>
<section id="bellondas-decoder-the-report-card" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-report-card">ğŸ Bellondaâ€™s Decoder: The Report Card</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> A single error number hides details. Did we fail in August? Did we nail December? We group the error by month to find weak spots.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>.groupby("month")</code> | <strong>The Slice</strong> | â€œAnalyze performance month-by-month.â€ | | <code>lambda x: ...</code> | <strong>The Mini-Function</strong> | â€œA throwaway function to calculate RMSE for each group.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œDiagnosing monthly forecast accuracy.â€</p>
<div id="48090cc5" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># graph relative RMSE (on holdout) per month</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>group <span class="op">=</span> data_holdout.sort_values(by<span class="op">=</span>[<span class="st">"date"</span>]).groupby(<span class="st">"month"</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>rmse_monthly <span class="op">=</span> pd.DataFrame(</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: group[<span class="st">"date"</span>].first(),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"RMSE"</span>: group.<span class="bu">apply</span>(</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: root_mean_squared_error(x[<span class="st">"QUANTITY"</span>], x[<span class="st">"y_hat_5"</span>])</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"RMSE_norm"</span>: group.<span class="bu">apply</span>(</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: root_mean_squared_error(x[<span class="st">"QUANTITY"</span>], x[<span class="st">"y_hat_5"</span>])</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">/</span> np.mean(x[<span class="st">"QUANTITY"</span>])</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="figure-18.7-b" class="level3">
<h3 class="anchored" data-anchor-id="figure-18.7-b">Figure 18.7 b)</h3>
</section>
<section id="bellondas-decoder-visualizing-failure" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-visualizing-failure">ğŸ Bellondaâ€™s Decoder: Visualizing Failure</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> We plot the monthly error bars. If one bar is huge, our model sucks at that time of year.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>sns.barplot</code> | <strong>The Chart</strong> | â€œDraw error bars.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œVisualizing accuracy by season.â€</p>
<div id="1fa69dbc" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"RMSE_norm"</span>, data<span class="op">=</span>rmse_monthly)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(rmse_monthly[<span class="st">"date"</span>].dt.strftime(<span class="st">"%b"</span>))</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(np.arange(<span class="dv">0</span>, <span class="fl">1.6</span>, <span class="fl">0.5</span>))</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Date (month)"</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"RMSE (normalized by monthly sales)"</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">"x"</span>, color<span class="op">=</span><span class="st">"gray"</span>, linestyle<span class="op">=</span><span class="st">"-"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:matplotlib.category:Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.
INFO:matplotlib.category:Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ch18-swimmingpool-predict-bellonda_from-qmd_files/figure-html/cell-34-output-2.png" width="593" height="472" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bellondas-decoder-the-shape-shifter-melt" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-shape-shifter-melt">ğŸ Bellondaâ€™s Decoder: The Shape Shifter (Melt)</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> Our data is lazy: it has one column for â€œActualâ€ and one for â€œPredictedâ€. But Seaborn (the plotter) demands â€œLong Dataâ€. It wants one column called â€œValueâ€ and another called â€œTypeâ€ (Actual/Predicted). We <code>melt</code> the table to reshape it.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>.melt()</code> | <strong>The Liquefier</strong> | â€œDissolve multiple columns into rows.â€ | | <code>.merge()</code> | <strong>The Stitch</strong> | â€œGlue the original data back on so we donâ€™t lose context.â€ | | <code>.assign()</code> | <strong>The Label Maker</strong> | â€œAdd a new column with pretty names for the legend.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œFormatting data for the final dashboard.â€</p>
<p><strong>4. ğŸŒ The Banana Peel (Watch Out!)</strong> &gt; [!WARNING] &gt; <strong>Donâ€™t slip here:</strong> This chain of functions is a beast. If you miss one parenthesis, the whole thing breaks. Indentation is key.</p>
<div id="f418be8b" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Frieren: Reshaping the timeline into a long format for the Sea-born Plotter (Seaborn)</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>plotdata <span class="op">=</span> (</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    data_holdout</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">filter</span>([<span class="st">"date"</span>, <span class="st">"month"</span>, <span class="st">"QUANTITY"</span>, <span class="st">"y_hat_5"</span>]) <span class="co"># Select only essential mana streams</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    .melt(id_vars<span class="op">=</span>[<span class="st">"date"</span>, <span class="st">"month"</span>]) <span class="co"># Unpivot: Collapsing Qty and Prediction into one column</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Re-attaching the original values for reference (Self-Join)</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    .merge(data_holdout.<span class="bu">filter</span>([<span class="st">"date"</span>, <span class="st">"QUANTITY"</span>]), on<span class="op">=</span><span class="st">"date"</span>) </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    .merge(data_holdout.<span class="bu">filter</span>([<span class="st">"date"</span>, <span class="st">"y_hat_5"</span>]), on<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Renaming for clarity in the legend</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"QUANTITY"</span>: <span class="st">"ymin"</span>, <span class="st">"y_hat_5"</span>: <span class="st">"ymax"</span>})</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        variable<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"variable"</span>].<span class="bu">map</span>(</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"QUANTITY"</span>: <span class="st">"Actual"</span>, <span class="st">"y_hat_5"</span>: <span class="st">"Predicted"</span>} <span class="co"># Renaming the labels</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="figure-18.6" class="level3">
<h3 class="anchored" data-anchor-id="figure-18.6">Figure 18.6</h3>
</section>
<section id="bellondas-decoder-the-moment-of-truth" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-moment-of-truth">ğŸ Bellondaâ€™s Decoder: The Moment of Truth</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> The Final Chart. Actual Sales (Blue) vs Predicted Sales (Orange). If the lines overlap perfectly, we are wizards.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>hue="variable"</code> | <strong>The Color</strong> | â€œColor lines differently based on if they are â€˜Actualâ€™ or â€˜Predictedâ€™.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œThe final forecast dashboard.â€</p>
<div id="e64ab664" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"value"</span>, hue<span class="op">=</span><span class="st">"variable"</span>, style<span class="op">=</span><span class="st">"variable"</span>, data<span class="op">=</span>plotdata)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>xticks <span class="op">=</span> pd.to_datetime(</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"2016-01-01"</span>, <span class="st">"2016-03-01"</span>, <span class="st">"2016-05-01"</span>, <span class="st">"2016-07-01"</span>, <span class="st">"2016-09-01"</span>, <span class="st">"2016-11-01"</span>]</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>xlabels <span class="op">=</span> [<span class="st">"01Jan2016"</span>, <span class="st">"01Mar2016"</span>, <span class="st">"01May2016"</span>, <span class="st">"01Jul2016"</span>, <span class="st">"01Sep2016"</span>, <span class="st">"01Nov2016"</span>]</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(xticks, labels<span class="op">=</span>xlabels, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>plt.xlim((datetime(<span class="dv">2016</span>, <span class="dv">1</span>, <span class="dv">1</span>), datetime(<span class="dv">2017</span>, <span class="dv">1</span>, <span class="dv">1</span>)))</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date (day)"</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily ticket sales"</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>plt.legend(bbox_to_anchor<span class="op">=</span>(<span class="fl">0.54</span>, <span class="fl">0.77</span>), frameon<span class="op">=</span><span class="va">False</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ch18-swimmingpool-predict-bellonda_from-qmd_files/figure-html/cell-36-output-1.png" width="597" height="470" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="figure-18.7-a" class="level3">
<h3 class="anchored" data-anchor-id="figure-18.7-a">Figure 18.7 a)</h3>
</section>
<section id="bellondas-decoder-the-microscope-again" class="level3">
<h3 class="anchored" data-anchor-id="bellondas-decoder-the-microscope-again">ğŸ Bellondaâ€™s Decoder: The Microscope (Again)</h3>
<p><strong>1. The â€œWhy are we doing this?â€</strong> The year-long chart is crowded. We zoom in on August to check the daily fit.</p>
<p><strong>2. Syntax Autopsy (The Python)</strong> | Code Fragment | The Role | The Translation | | :â€” | :â€” | :â€” | | <code>[plotdata["month"] == 8]</code> | <strong>The Filter</strong> | â€œShow me August.â€ |</p>
<p><strong>3. ğŸ‘” The Manager Translation</strong> â€œDetailed inspection of peak season performance.â€</p>
<div id="e3cc45d4" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Frieren: Focusing the mage sight on a single month (August) to inspect the fine details.</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>plotdata_august <span class="op">=</span> plotdata[plotdata[<span class="st">"month"</span>] <span class="op">==</span> <span class="dv">8</span>].reset_index()</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>sns.lineplot(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"value"</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"variable"</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    style<span class="op">=</span><span class="st">"variable"</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>plotdata_august,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>plt.fill_between(</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    plotdata_august.loc[<span class="kw">lambda</span> x: x[<span class="st">"variable"</span>] <span class="op">==</span> <span class="st">"Actual"</span>, <span class="st">"date"</span>],</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    plotdata_august.loc[<span class="kw">lambda</span> x: x[<span class="st">"variable"</span>] <span class="op">==</span> <span class="st">"Actual"</span>, <span class="st">"ymin"</span>],</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    plotdata_august.loc[<span class="kw">lambda</span> x: x[<span class="st">"variable"</span>] <span class="op">==</span> <span class="st">"Actual"</span>, <span class="st">"ymax"</span>],</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>da.color[<span class="dv">3</span>],</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>plt.xticks(</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    pd.to_datetime(</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"2016-08-01"</span>, <span class="st">"2016-08-08"</span>, <span class="st">"2016-08-15"</span>, <span class="st">"2016-08-22"</span>, <span class="st">"2016-08-29"</span>]</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[<span class="st">"01Aug"</span>, <span class="st">"08Aug"</span>, <span class="st">"15Aug"</span>, <span class="st">"22Aug"</span>, <span class="st">"29Aug"</span>],</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">150</span>)</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>plt.xlim((datetime(<span class="dv">2016</span>, <span class="dv">8</span>, <span class="dv">1</span>), datetime(<span class="dv">2016</span>, <span class="dv">8</span>, <span class="dv">31</span>)))</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>plt.yticks(np.arange(<span class="dv">0</span>, <span class="dv">151</span>, <span class="dv">50</span>))</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date (day)"</span>)</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily ticket sales"</span>)</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>plt.legend(</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">""</span>, loc<span class="op">=</span><span class="st">"upper left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">0.54</span>, <span class="fl">0.77</span>), frameon<span class="op">=</span><span class="va">False</span>, ncol<span class="op">=</span><span class="dv">2</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ch18-swimmingpool-predict-bellonda_from-qmd_files/figure-html/cell-37-output-1.png" width="597" height="478" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="the-senior-syntax-checklist" class="level1">
<h1>ğŸ“ The Senior Syntax Checklist</h1>
<section id="tools-mastery" class="level2">
<h2 class="anchored" data-anchor-id="tools-mastery">ğŸ› ï¸ Tools Mastery</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Method/Library</th>
<th style="text-align: left;">What it <em>actually</em> does</th>
<th style="text-align: left;">Generic Syntax Template</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>pd.read_csv(parse_dates=...)</code></td>
<td style="text-align: left;">Time-travel loader</td>
<td style="text-align: left;"><code>pd.read_csv('file.csv', parse_dates=['col'])</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>.dt.property</code></td>
<td style="text-align: left;">Time extraction</td>
<td style="text-align: left;"><code>df['date'].dt.month</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>(A) &amp; (B)</code></td>
<td style="text-align: left;">Safe logic gates</td>
<td style="text-align: left;"><code>(df['A'] &gt; 1) &amp; (df['B'] &lt; 5)</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>.transform()</code></td>
<td style="text-align: left;">Broadcasting</td>
<td style="text-align: left;"><code>df.groupby('g')['v'].transform('mean')</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>.melt()</code></td>
<td style="text-align: left;">Reshaping for plots</td>
<td style="text-align: left;"><code>df.melt(id_vars=['id'], value_vars=['A', 'B'])</code></td>
</tr>
</tbody>
</table>
</section>
<section id="eli5-syntax-appendix-the-explain-like-im-5-dictionary" class="level2">
<h2 class="anchored" data-anchor-id="eli5-syntax-appendix-the-explain-like-im-5-dictionary">ğŸ‘¶ ELI5 Syntax Appendix (The â€œExplain Like Iâ€™m 5â€ Dictionary)</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Term</th>
<th style="text-align: left;">ELI5 Analogy</th>
<th style="text-align: left;">Minimal Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>pd.DataFrame</code></td>
<td style="text-align: left;">Itâ€™s an Excel sheet that lives inside your computerâ€™s RAM.</td>
<td style="text-align: left;"><code>df = pd.DataFrame({"A": [1, 2]})</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>.groupby()</code></td>
<td style="text-align: left;">Like sorting a deck of cards into piles by suit (Hearts, Spades).</td>
<td style="text-align: left;"><code>df.groupby("suit")</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>.transform("mean")</code></td>
<td style="text-align: left;">Asking the dealer the average card value for each suit, then writing that number on <em>every</em> card of that suit.</td>
<td style="text-align: left;"><code>df.groupby("suit")["val"].transform("mean")</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>.melt()</code></td>
<td style="text-align: left;">Taking a â€œwideâ€ spreadsheet (cols: Jan, Feb, Mar) and making it â€œlongâ€ (rows: Month=Jan, Val=10).</td>
<td style="text-align: left;"><code>df.melt(id_vars=["ID"])</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>np.log()</code></td>
<td style="text-align: left;">Squashing big numbers. Imagine a volume knob 1-100. Log turns it into 1-2.</td>
<td style="text-align: left;"><code>np.log(df["sales"])</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>Prophet</code></td>
<td style="text-align: left;">A tiny robot provided by Facebook that is really good at guessing future patterns.</td>
<td style="text-align: left;"><code>m = Prophet(); m.fit(df)</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>RMSE</code></td>
<td style="text-align: left;">The â€œGradeâ€. It tells you how wrong you are on average. Lower is better.</td>
<td style="text-align: left;"><code>root_mean_squared_error(y_true, y_pred)</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>Boolean Mask</code></td>
<td style="text-align: left;">A filter. Like sieve. We keep â€œTrueâ€ rows and throw away â€œFalseâ€ rows.</td>
<td style="text-align: left;"><code>mask = df["age"] &gt; 18</code></td>
</tr>
</tbody>
</table>
</section>
<section id="bellondas-final-thought" class="level2">
<h2 class="anchored" data-anchor-id="bellondas-final-thought">ğŸ§  Bellondaâ€™s Final Thought</h2>
<p>â€œYou survived the Time-Series Gauntlet. Most people quit after the <code>melt</code> function. You didnâ€™t. Go get a coffee.â€</p>
</section>
</section>

</main>
<!-- /main column -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{"206a754ab6234e8b957d7d8c863ef03c":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"28fc31b870f0452a802524f798fd97d6":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_3d7f7a7e89114b0c807eaa40982c3ef2","max":5,"min":0,"orientation":"horizontal","style":"IPY_MODEL_dda42d53ae5e448a8a7702e2dd9c3d5a","tabbable":null,"tooltip":null,"value":5}},"3d7f7a7e89114b0c807eaa40982c3ef2":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"43d67e9d72a641cd956c0a1092880e86":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"5f064169aabe45ee895eddbb2f0b3a5e":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_206a754ab6234e8b957d7d8c863ef03c","placeholder":"â€‹","style":"IPY_MODEL_f82824d826c44f5cbdaec9c15dfd356e","tabbable":null,"tooltip":null,"value":"100%"}},"7b40a8acb7fb440395d4d70246279143":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_7f36c4cb656343e2a99b33676f09714d","placeholder":"â€‹","style":"IPY_MODEL_43d67e9d72a641cd956c0a1092880e86","tabbable":null,"tooltip":null,"value":"â€‡5/5â€‡[00:01&lt;00:00,â€‡â€‡3.79it/s]"}},"7f36c4cb656343e2a99b33676f09714d":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"a3b327bc48114fa6bd6b58acbf8c8fe9":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_5f064169aabe45ee895eddbb2f0b3a5e","IPY_MODEL_28fc31b870f0452a802524f798fd97d6","IPY_MODEL_7b40a8acb7fb440395d4d70246279143"],"layout":"IPY_MODEL_cc3e7f9ca7184d44a49f1cbb3c281526","tabbable":null,"tooltip":null}},"cc3e7f9ca7184d44a49f1cbb3c281526":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"dda42d53ae5e448a8a7702e2dd9c3d5a":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"f82824d826c44f5cbdaec9c15dfd356e":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}}},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>